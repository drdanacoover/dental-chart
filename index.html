<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dog Dental Chart Builder (Triadan)</title>

  <!-- PDF export libs (client-side) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    h2 { margin: 0 0 6px 0; }
    .sub { color:#555; font-size:12px; margin-bottom:12px; }

    .layout { display:flex; gap:16px; flex-wrap:wrap; align-items:flex-start; }
    .card { border:1px solid #ddd; border-radius:12px; padding:12px; background:#fff; }

    /* Everything inside #capture is exported to PDF */
    #capture { padding: 12px; border: 1px solid #eee; border-radius: 12px; }

    .headerGrid {
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-bottom: 10px;
    }
    .field label { display:block; font-size:11px; color:#555; margin-bottom:4px; }
    .field input { width:100%; padding:7px; font-size:12px; border:1px solid #ccc; border-radius:8px; }

    #stage { position:relative; width:400px; height:400px; border:1px solid #ccc; border-radius:10px; overflow:hidden; }
    #baseImg { position:absolute; inset:0; width:400px; height:400px; display:block; }
    #overlay { position:absolute; inset:0; }

    table { width:100%; border-collapse:collapse; font-size:12px; }
    th, td { border:1px solid #ccc; padding:6px; vertical-align:top; }
    thead th { background:#f2f2f2; }

    .btnrow { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    button { padding:8px 10px; cursor:pointer; border:1px solid #ccc; background:#fff; border-radius:8px; }
    button.primary { border-color:#1a73e8; background:#1a73e8; color:#fff; }
    button.danger { border-color:#b3261e; color:#b3261e; }

    .legend { font-size:12px; color:#444; margin-top:8px; display:flex; gap:12px; flex-wrap:wrap; }
    .chip { display:inline-flex; align-items:center; gap:6px; }
    .dot { width:12px; height:12px; border-radius:50%; display:inline-block; border:1px solid #999; }
    .dotBlack { background:#000; border-color:#000; }
    .dotGrey  { background:#bdbdbd; border-color:#bdbdbd; }
    .dotPink  { background:#ff66b2; border-color:#ff66b2; }

    /* Modal */
    #backdrop { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:9998; }
    #modal {
      display:none; position:fixed; left:50%; top:10%; transform:translateX(-50%);
      width:380px; background:#fff; border:1px solid #ccc; border-radius:12px;
      padding:12px; z-index:9999;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    #modal label { display:block; margin:8px 0; font-size:12px; }
    #modal select, #modal input, #modal textarea {
      width:100%; padding:7px; font-size:12px; border:1px solid #ccc; border-radius:8px;
    }
    #modal .top { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    #modal .top b { font-size:14px; }
    #modal .actions { display:flex; justify-content:flex-end; gap:8px; margin-top:10px; }
    #modalClose { padding:4px 8px; }

    .note { font-size:11px; color:#666; margin-top:8px; }
    .muted { color:#777; }
  </style>
</head>

<body>
  <h2>Dog Dental Chart Builder (Triadan)</h2>
  <div class="sub">
    Upload this page to GoDaddy with <b>dog_chart.png</b> in the same folder. Click teeth → chart → Download PDF → upload into ezyVet.
  </div>

  <div class="layout">
    <!-- PDF CAPTURE AREA -->
    <div id="capture" class="card" style="max-width:980px;">
      <div class="headerGrid">
        <div class="field">
          <label>Patient</label>
          <input id="fPatient" placeholder="Patient name" />
        </div>
        <div class="field">
          <label>Date</label>
          <input id="fDate" placeholder="YYYY-MM-DD" />
        </div>
        <div class="field">
          <label>Clinic / Doctor</label>
          <input id="fClin" placeholder="Clinic / Doctor" />
        </div>
      </div>

      <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:flex-start;">
        <!-- Chart -->
        <div>
          <div id="stage">
            <!-- Put your chart image next to this HTML file and name it dog_chart.png -->
            <img id="baseImg" src="dog_chart.png" alt="Dog dental chart" />
            <svg id="overlay" width="400" height="400"></svg>
          </div>

          <div class="legend">
            <span class="chip"><span class="dot dotBlack"></span>Extracted</span>
            <span class="chip"><span class="dot dotGrey"></span>Missing</span>
            <span class="chip"><span class="dot dotPink"></span>Noted (anything else)</span>
          </div>

          <div class="note">
            Click a tooth area to chart it (popup resets each click). Use “Edit” in the table to adjust a tooth later.
          </div>
        </div>

        <!-- Table -->
        <div style="min-width:480px; flex:1;">
          <div style="font-weight:bold; margin-bottom:8px;">Charted teeth (only what you click)</div>

          <table>
            <thead>
              <tr>
                <th style="width:70px;">Tooth</th>
                <th style="width:100px;">Status</th>
                <th style="width:55px;">PD</th>
                <th style="width:70px;">Furc</th>
                <th>Other</th>
                <th style="width:70px;">Edit</th>
              </tr>
            </thead>
            <tbody id="rows">
              <tr id="emptyRow"><td colspan="6" class="muted">No teeth charted yet.</td></tr>
            </tbody>
          </table>

          <div class="note">
            PD: 0–4 (0 normal, 1 gingivitis, 2 &lt;25%, 3 25–50%, 4 &gt;50%) • Furcation: 0–3
          </div>
        </div>
      </div>
    </div>

    <!-- ACTIONS (not captured) -->
    <div class="card" style="min-width:320px; max-width:420px;">
      <div style="font-weight:bold; margin-bottom:8px;">Export</div>
      <div class="btnrow">
        <button class="primary" id="btnPdf">Download PDF</button>
        <button id="btnClear" class="danger">Clear All</button>
      </div>

      <div class="note" style="margin-top:10px;">
        If you prefer, you can also copy the JSON summary below for your notes.
      </div>
      <textarea id="jsonOut" style="width:100%; height:240px; font-size:11px; padding:8px; border:1px solid #ccc; border-radius:10px;"></textarea>
    </div>
  </div>

  <!-- MODAL -->
  <div id="backdrop"></div>
  <div id="modal">
    <div class="top">
      <b>Tooth: <span id="m_tooth"></span></b>
      <button type="button" id="modalClose">X</button>
    </div>

    <label>Status
      <select id="m_status">
        <option value="">(select)</option>
        <option value="missing">Missing</option>
        <option value="extracted">Extracted</option>
        <option value="noted">Noted (other)</option>
      </select>
    </label>

    <label>Periodontal disease level (0–4)
      <select id="m_pd">
        <option value=""></option>
        <option value="0">0</option><option value="1">1</option><option value="2">2</option>
        <option value="3">3</option><option value="4">4</option>
      </select>
    </label>

    <label>Furcation (0–3)
      <select id="m_furc">
        <option value=""></option>
        <option value="0">0</option><option value="1">1</option>
        <option value="2">2</option><option value="3">3</option>
      </select>
    </label>

    <label>Other
      <input id="m_other" placeholder="fracture, resorption, gingival mass, etc." />
    </label>

    <div class="actions">
      <button type="button" id="m_remove" class="danger">Remove tooth</button>
      <button type="button" id="m_save" class="primary">Save</button>
    </div>

    <div class="note">Tip: “Noted” will show pink on the chart. Missing = grey. Extracted = black.</div>
  </div>

<script>
(() => {
  // --- Tooth center points for 400x400 chart (starter positions) ---
  // If you want pixel-perfect placement, we can refine these by clicking your exact chart.
  const centers = {
    "101":[190,64],"102":[205,64],"103":[220,70],"104":[245,96],
    "105":[260,130],"106":[270,150],"107":[280,170],"108":[295,195],"109":[310,225],"110":[320,245],
    "201":[210,64],"202":[225,64],"203":[240,70],"204":[155,96],
    "205":[140,130],"206":[130,150],"207":[120,170],"208":[105,195],"209":[90,225],"210":[80,245],
    "301":[210,342],"302":[225,342],"303":[240,336],"304":[155,306],
    "305":[140,275],"306":[130,255],"307":[120,235],"308":[105,210],"309":[90,180],"310":[80,160],"311":[70,142],
    "401":[190,342],"402":[205,342],"403":[220,336],"404":[245,306],
    "405":[260,275],"406":[270,255],"407":[280,235],"408":[295,210],"409":[310,180],"410":[320,160],"411":[330,142]
  };

  // --- UI elements ---
  const overlay = document.getElementById("overlay");
  const rows = document.getElementById("rows");
  const emptyRow = document.getElementById("emptyRow");
  const jsonOut = document.getElementById("jsonOut");

  const backdrop = document.getElementById("backdrop");
  const modal = document.getElementById("modal");
  const modalClose = document.getElementById("modalClose");

  const mTooth = document.getElementById("m_tooth");
  const mStatus = document.getElementById("m_status");
  const mPd = document.getElementById("m_pd");
  const mFurc = document.getElementById("m_furc");
  const mOther = document.getElementById("m_other");
  const mSave = document.getElementById("m_save");
  const mRemove = document.getElementById("m_remove");

  // --- State ---
  // findings[tooth] = {status, pd, furc, other}
  const findings = {};
  let currentTooth = null;

  function resetModalFields() {
    mStatus.value = "";
    mPd.value = "";
    mFurc.value = "";
    mOther.value = "";
  }

  function openModal(tooth, loadExisting) {
    currentTooth = tooth;
    mTooth.textContent = tooth;

    if (loadExisting && findings[tooth]) {
      const f = findings[tooth];
      mStatus.value = f.status || "";
      mPd.value = (f.pd ?? "");
      mFurc.value = (f.furc ?? "");
      mOther.value = f.other || "";
    } else {
      // User request: reset between clicks
      resetModalFields();
    }

    backdrop.style.display = "block";
    modal.style.display = "block";
    mStatus.focus();
  }

  function closeModal() {
    backdrop.style.display = "none";
    modal.style.display = "none";
    currentTooth = null;
  }

  function colorForStatus(status) {
    if (status === "extracted") return "#000000"; // black
    if (status === "missing") return "#bdbdbd";   // grey
    return "#ff66b2";                              // pink for "noted" or anything else
  }

  function syncJson() {
    jsonOut.value = JSON.stringify(findings, null, 2);
  }

  function clearOverlay() {
    while (overlay.firstChild) overlay.removeChild(overlay.firstChild);
  }

  function drawOverlay() {
    clearOverlay();

    // Invisible click targets (no visible overlay)
    for (const [tooth, [x, y]] of Object.entries(centers)) {
      const hit = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      hit.setAttribute("cx", x);
      hit.setAttribute("cy", y);
      hit.setAttribute("r", 14);
      hit.setAttribute("fill", "transparent");
      hit.style.cursor = "pointer";
      hit.addEventListener("click", () => openModal(tooth, false));
      overlay.appendChild(hit);
    }

    // Visible markers ONLY for charted teeth
    for (const [tooth, f] of Object.entries(findings)) {
      const xy = centers[tooth];
      if (!xy) continue;
      const [x, y] = xy;

      const col = colorForStatus(f.status);
      const m = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      m.setAttribute("cx", x);
      m.setAttribute("cy", y);
      m.setAttribute("r", 10);
      m.setAttribute("fill", col);
      m.setAttribute("stroke", col);

      // allow clicking a marked tooth to edit (loads existing values)
      m.style.cursor = "pointer";
      m.addEventListener("click", (e) => {
        e.stopPropagation();
        openModal(tooth, true);
      });

      overlay.appendChild(m);
    }
  }

  function updateTable() {
    // Clear table body
    rows.innerHTML = "";

    const teeth = Object.keys(findings).sort((a,b) => Number(a) - Number(b));
    if (teeth.length === 0) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="6" class="muted">No teeth charted yet.</td>`;
      rows.appendChild(tr);
      return;
    }

    teeth.forEach((tooth) => {
      const f = findings[tooth];

      const tr = document.createElement("tr");
      const tdTooth = document.createElement("td");
      tdTooth.textContent = tooth;

      const tdStatus = document.createElement("td");
      tdStatus.textContent = f.status || "";

      const tdPd = document.createElement("td");
      tdPd.textContent = (f.pd ?? "");

      const tdF = document.createElement("td");
      tdF.textContent = (f.furc ?? "");

      const tdOther = document.createElement("td");
      tdOther.textContent = f.other || "";

      const tdEdit = document.createElement("td");
      const btn = document.createElement("button");
      btn.type = "button";
      btn.textContent = "Edit";
      btn.addEventListener("click", () => openModal(tooth, true));
      tdEdit.appendChild(btn);

      tr.appendChild(tdTooth);
      tr.appendChild(tdStatus);
      tr.appendChild(tdPd);
      tr.appendChild(tdF);
      tr.appendChild(tdOther);
      tr.appendChild(tdEdit);

      rows.appendChild(tr);
    });
  }

  // Modal buttons
  modalClose.addEventListener("click", closeModal);
  backdrop.addEventListener("click", closeModal);

  mSave.addEventListener("click", () => {
    if (!currentTooth) return;

    const status = mStatus.value;
    if (!status) {
      alert("Please select a Status (Missing / Extracted / Noted).");
      return;
    }

    findings[currentTooth] = {
      status,
      pd: mPd.value,
      furc: mFurc.value,
      other: (mOther.value || "").trim()
    };

    syncJson();
    updateTable();
    drawOverlay();
    closeModal();
  });

  mRemove.addEventListener("click", () => {
    if (!currentTooth) return;
    delete findings[currentTooth];
    syncJson();
    updateTable();
    drawOverlay();
    closeModal();
  });

  // Clear all
  document.getElementById("btnClear").addEventListener("click", () => {
    if (!confirm("Clear all charted teeth?")) return;
    for (const k of Object.keys(findings)) delete findings[k];
    syncJson();
    updateTable();
    drawOverlay();
  });

  // PDF export
  document.getElementById("btnPdf").addEventListener("click", async () => {
    const capture = document.getElementById("capture");

    // Ensure image loaded
    const img = document.getElementById("baseImg");
    if (!img.complete) await new Promise(r => img.onload = r);

    const canvas = await html2canvas(capture, {
      scale: 2,
      useCORS: true,
      backgroundColor: "#ffffff"
    });

    const imgData = canvas.toDataURL("image/png");

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation: "portrait", unit: "pt", format: "letter" });

    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();

    // Fit image to page with margins
    const margin = 24;
    const maxW = pageW - margin * 2;
    const maxH = pageH - margin * 2;

    const ratio = Math.min(maxW / canvas.width, maxH / canvas.height);
    const w = canvas.width * ratio;
    const h = canvas.height * ratio;

    pdf.addImage(imgData, "PNG", margin, margin, w, h);

    // File name
    const patient = (document.getElementById("fPatient").value || "patient").trim().replace(/\s+/g, "_");
    const date = (document.getElementById("fDate").value || "date").trim().replace(/\s+/g, "_");
    pdf.save(`dental_chart_${patient}_${date}.pdf`);
  });

  // Initialize
  syncJson();
  updateTable();
  drawOverlay();
})();
</script>
</body>
</html>
