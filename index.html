<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dog Dental Chart Builder</title>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
  body { font-family: Arial; margin:16px; }
  h2 { margin:0 0 6px 0; }
  .sub { font-size:12px; color:#555; margin-bottom:12px; }

  #capture { border:1px solid #eee; padding:12px; border-radius:12px; }

  .header { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:12px; }
  .header input { padding:6px; border:1px solid #ccc; border-radius:6px; }

  #stage { position:relative; width:400px; height:400px; border:1px solid #ccc; border-radius:10px; overflow:hidden; }
  #baseImg { position:absolute; inset:0; width:400px; height:400px; }
  #overlay { position:absolute; inset:0; }

  .legend { margin-top:8px; font-size:12px; display:flex; gap:12px; flex-wrap:wrap; }
  .dot { width:12px; height:12px; border-radius:50%; display:inline-block; vertical-align:middle; margin-right:6px; }
  .black { background:#000; }
  .grey { background:#bdbdbd; }
  .pink { background:#ff66b2; }

  table { width:100%; border-collapse:collapse; font-size:12px; margin-top:10px; }
  th,td { border:1px solid #ccc; padding:6px; }
  th { background:#f2f2f2; }

  button { padding:6px 10px; margin-top:10px; cursor:pointer; border-radius:6px; border:1px solid #ccc; background:#fff; }
  .primary { background:#1a73e8; color:#fff; border:none; }

  #modalBackdrop {
    display:none; position:fixed; inset:0;
    background:rgba(0,0,0,0.35);
  }
  #modal {
    display:none; position:fixed; left:50%; top:12%;
    transform:translateX(-50%);
    width:360px; background:#fff;
    border:1px solid #ccc; border-radius:10px;
    padding:12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  }
  #modal label { display:block; margin-top:10px; font-size:12px; }
  #modal select,#modal input { width:100%; padding:6px; margin-top:4px; }
  #modal .row { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
</style>
</head>

<body>

<h2>Dog Dental Chart Builder (Triadan)</h2>
<div class="sub">
  Click tooth → choose status/notes → Save. Download PDF and upload into ezyVet.
</div>

<div id="capture">

  <div class="header">
    <input id="patient" placeholder="Patient">
    <input id="date" placeholder="Date">
    <input id="doctor" placeholder="Doctor">
  </div>

  <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:flex-start;">

    <div>
      <div id="stage">
        <!-- IMPORTANT: file name must match exactly (case-sensitive on GitHub) -->
        <img id="baseImg" src="Dog.gif" alt="Dental chart">
        <svg id="overlay" width="400" height="400"></svg>
      </div>

      <div class="legend">
        <span><span class="dot black"></span see>Extracted</span>
        <span><span class="dot grey"></span>Missing</span>
        <span><span class="dot pink"></span>Noted</span>
      </div>
    </div>

    <div style="min-width:420px; flex:1;">
      <table>
        <thead>
          <tr>
            <th style="width:70px;">Tooth</th>
            <th style="width:100px;">Status</th>
            <th style="width:55px;">PD</th>
            <th style="width:70px;">Furc</th>
            <th>Other</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="5" style="color:#777;">No teeth charted yet</td></tr>
        </tbody>
      </table>
    </div>

  </div>
</div>

<button class="primary" id="pdfBtn">Download PDF</button>

<!-- Modal -->
<div id="modalBackdrop"></div>
<div id="modal">
  <b>Tooth: <span id="modalTooth"></span></b>

  <label>Status
    <select id="status">
      <option value="">Select</option>
      <option value="extracted">Extracted (black)</option>
      <option value="missing">Missing (grey)</option>
      <option value="noted">Noted (pink)</option>
    </select>
  </label>

  <label>PD (0–4)
    <select id="pd">
      <option value=""></option>
      <option>0</option><option>1</option><option>2</option><option>3</option><option>4</option>
    </select>
  </label>

  <label>Furcation (0–3)
    <select id="furc">
      <option value=""></option>
      <option>0</option><option>1</option><option>2</option><option>3</option>
    </select>
  </label>

  <label>Other
    <input id="other" placeholder="fracture, resorption, etc.">
  </label>

  <div class="row">
    <button id="closeBtn">Cancel</button>
    <button id="saveBtn" class="primary">Save</button>
  </div>
</div>

<script>
  // Tooth center points for the 400x400 chart (starter positions)
  const centers = {
    "101":[190,64],"102":[205,64],"103":[220,70],"104":[245,96],
    "105":[260,130],"106":[270,150],"107":[280,170],"108":[295,195],"109":[310,225],"110":[320,245],
    "201":[210,64],"202":[225,64],"203":[240,70],"204":[155,96],
    "205":[140,130],"206":[130,150],"207":[120,170],"208":[105,195],"209":[90,225],"210":[80,245],
    "301":[210,342],"302":[225,342],"303":[240,336],"304":[155,306],
    "305":[140,275],"306":[130,255],"307":[120,235],"308":[105,210],"309":[90,180],"310":[80,160],"311":[70,142],
    "401":[190,342],"402":[205,342],"403":[220,336],"404":[245,306],
    "405":[260,275],"406":[270,255],"407":[280,235],"408":[295,210],"409":[310,180],"410":[320,160],"411":[330,142]
  };

  let findings = {}; // tooth -> {status,pd,furc,other}
  let currentTooth = null;

  const overlay = document.getElementById("overlay");
  const rows = document.getElementById("rows");

  function openModal(tooth){
    currentTooth = tooth;
    document.getElementById("modalTooth").textContent = tooth;

    // Reset between clicks (as requested)
    document.getElementById("status").value = "";
    document.getElementById("pd").value = "";
    document.getElementById("furc").value = "";
    document.getElementById("other").value = "";

    document.getElementById("modalBackdrop").style.display = "block";
    document.getElementById("modal").style.display = "block";
  }

  function closeModal(){
    document.getElementById("modalBackdrop").style.display = "none";
    document.getElementById("modal").style.display = "none";
    currentTooth = null;
  }

  document.getElementById("closeBtn").onclick = closeModal;
  document.getElementById("modalBackdrop").onclick = closeModal;

  // QUICK FIX:
  // - Draw visual marks with pointer-events NONE so they never block clicks
  // - Draw click targets with pointer-events ALL and larger radius
  function draw(){
    while (overlay.firstChild) overlay.removeChild(overlay.firstChild);

    // 1) Visual marks first (they will NOT intercept clicks)
    for (const [tooth, f] of Object.entries(findings)){
      const [x,y] = centers[tooth] || [];
      if (x == null) continue;

      const mark = document.createElementNS("http://www.w3.org/2000/svg","ellipse");
      mark.setAttribute("cx", x);
      mark.setAttribute("cy", y);
      mark.setAttribute("rx", 16);
      mark.setAttribute("ry", 12);

      if (f.status === "extracted") mark.setAttribute("fill", "#000");
      else if (f.status === "missing") mark.setAttribute("fill", "#bdbdbd");
      else mark.setAttribute("fill", "#ff66b2");

      mark.setAttribute("opacity", "0.85");
      mark.setAttribute("pointer-events", "none"); // critical: don't block clicks
      overlay.appendChild(mark);
    }

    // 2) Click targets on top (always clickable)
    for (const [tooth,[x,y]] of Object.entries(centers)){
      const hit = document.createElementNS("http://www.w3.org/2000/svg","circle");
      hit.setAttribute("cx", x);
      hit.setAttribute("cy", y);
      hit.setAttribute("r", 22);                 // bigger click target
      hit.setAttribute("fill", "transparent");
      hit.setAttribute("pointer-events", "all"); // ensure clicks always work
      hit.style.cursor = "pointer";
      hit.addEventListener("click", () => openModal(tooth));
      overlay.appendChild(hit);
    }
  }

  function updateTable(){
    rows.innerHTML = "";
    const keys = Object.keys(findings);

    if (keys.length === 0){
      rows.innerHTML = '<tr><td colspan="5" style="color:#777;">No teeth charted yet</td></tr>';
      return;
    }

    keys.sort((a,b)=>Number(a)-Number(b));
    for (const t of keys){
      const f = findings[t] || {};
      rows.innerHTML +=
        "<tr>" +
          "<td>"+t+"</td>" +
          "<td>"+(f.status || "")+"</td>" +
          "<td>"+(f.pd || "")+"</td>" +
          "<td>"+(f.furc || "")+"</td>" +
          "<td>"+(f.other || "")+"</td>" +
        "</tr>";
    }
  }

  document.getElementById("saveBtn").onclick = function(){
    if (!currentTooth) return;

    const status = document.getElementById("status").value;
    if (!status){
      alert("Please select a Status.");
      return;
    }

    findings[currentTooth] = {
      status,
      pd: document.getElementById("pd").value,
      furc: document.getElementById("furc").value,
      other: document.getElementById("other").value
    };

    updateTable();
    draw();
    closeModal();
  };

  document.getElementById("pdfBtn").onclick = async function(){
    // Ensure image loaded before capture
    const img = document.getElementById("baseImg");
    if (!img.complete) await new Promise(r => img.onload = r);

    const canvas = await html2canvas(document.getElementById("capture"), {scale:2, backgroundColor:"#fff"});
    const imgData = canvas.toDataURL("image/png");

    const {jsPDF} = window.jspdf;
    const pdf = new jsPDF({unit:"pt", format:"letter"});

    // Fit reasonably on page
    pdf.addImage(imgData, "PNG", 20, 20, 572, 752);
    pdf.save("dental_chart.pdf");
  };

  // Init
  updateTable();
  draw();
</script>

</body>
</html>
